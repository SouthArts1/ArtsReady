<h1>Edit Billing Information</h1>

<ul class="top-nav settings">
    <li><%= link_to 'My Info', profile_path %></li>    
    <li class=""><%= link_to "Organization", edit_organization_path(current_org) %></li>
    <li class=""><%= link_to "Our Team", organization_users_path(current_org) %></li>
		<li class="active"><%= link_to "Billing", billing_my_organization_path %></li>
    <li class=""><%= link_to "Previous Crises", organization_crises_path(current_org) %></li>
</ul>

<div class="grid_8">
  <section>
    <%= form_for @payment, url: billing_path, method: "PUT" do |f| %>
			<%= f.hidden_field :id, value: @payment.id %>
			<%= f.hidden_field :discount_code_id, value: @payment.discount_code_id %>
			<p>
				<%= f.label :billing_first_name %><br />
				<%= f.text_field :billing_first_name %><br />
			</p>
			<p>
				<%= f.label :billing_last_name %><br />
				<%= f.text_field :billing_last_name %><br />
			</p>
			<p>
				<%= f.label :billing_address %><br />
				<%= f.text_field :billing_address %><br />
			</p>
			<p>
				<%= f.label :billing_city %><br />
				<%= f.text_field :billing_city %><br />
			</p>
			<p>
				<%= f.label :billing_state %><br />
				<%= f.text_field :billing_state %><br />
			</p>
			<p>
				<%= f.label :billing_zipcode %><br />
				<%= f.text_field :billing_zipcode %><br />
			</p>
			
			Payment information:
			<br />
			<table style="border:none;">
				<tr>
					<td style="border:none; width:60px;"></td>
					<td style="border:none; width:200px;"><h4>Annual Subscription:</h4></td>
					<td style="border:none;">
						<h4>
						<% if @payment.starting_amount_in_cents > 7500 %>
							<%= money_from_cents(@payment.starting_amount_in_cents - 7500) %>
						<% else %>
							<%= money_from_cents(@payment.starting_amount_in_cents) %>
						<% end %>
						</h4>
					</td>
				</tr>
				<tr>
					<td style="border:none; width:60px;"></td>
					<td style="border:none; width:200px;"><h4>First Year Fee:</h4></td>
					<td style="border:none;">
						<h4>
							<% if @payment.starting_amount_in_cents > 7500 %>
								$75.00
							<% else %>
								Waived!
							<% end %>
						</h4>
					</td>
				</tr>
				<tr>
					<td style="border:none; width:60px;"></td>
					<td style="border:none; width:200px;"><h4>Total Due:</h4></td>
					<td style="border:none;"><h4><%= money_from_cents @payment.starting_amount_in_cents %></h4></td>
				</tr>
			</table>
			<br />
			<p>
				Have a discount code? <input type="text" id="discount_code" style="width:200px;" /><br />
				<br />
				<p style="margin-left:138px;">
					<input type="button" id="discount_submit" value="Use my discount code!" style="text-decoration: none; border: 1px solid #C31D29; padding: 5px 8px; font-weight: bold; vertical-align: middle; cursor: pointer; color: white; font-size: 12px; text-decoration: none; letter-spacing: normal; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px; background-color: #C31D29; background-image: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(255, 255, 255, 0.25)), to(#C31D29)); background-image: -moz-linear-gradient(center top, rgba(255, 255, 255, 0.25), #C31D29); box-shadow: 0 1px 1px 1px rgba(255, 255, 255, 0.25) inset; -moz-box-shadow: 0 1px 1px 1px rgba(255, 255, 255, 0.25) inset; -webkit-box-shadow: 0 1px 1px 1px rgba(255, 255, 255, 0.25) inset;" /><br /><br />
					<em>If you have been subsidized by an <span style="color:#C31D29;">ArtsReady Partner</span>, please contact the <span  style="color:#C31D29;">ArtsReady Team</span> for your discount code.</em>
				</p>
			</p>
			<% if @payment.payment_method == "Credit Card" %>
				<div id="cc_info">
					<table style="border:none;">
						<tr>
							<td><p>Credit Card Number:</p></td>
							<td><p><%= f.text_field :number %> <%= image_tag "cc_image.jpg", :width => "120px" %></p>
								<p id="bad_card" style="color:#ff0000; display:none;">Credit Card Number is invalid.</p></td>
						</tr>
						<tr>
							<td><p>Expiration Date:</p></td>
							<td><p><%= f.select :expiry_month, options_for_select([1,2,3,4,5,6,7,8,9,10,11,12]) %> <%= f.date_select :expiry_year, :order => [:year] %></p></td>
						</tr>
						<tr>
							<td><p>Verification Number (CCV):</p></td>
							<td><p><%= f.text_field :ccv %></p></td>
						</tr>
					</table>
					<br />
				</div>
			<% else %>
				<div id="bank_info">
					<table>
						<tr>
							<td><p>Bank Name:</p></td>
							<td><p><%= f.text_field :bank_name %></p></td>
						</tr>
						<tr>
							<td><p>Account Type:</p></td>
							<td><p><%= f.select :account_type, ["Checking", "Savings"] %></p></td>
						</tr>
						<tr>
							<td><p>ABA Routing Number:</p></td>
							<td><p><%= f.text_field :routing_number %></p></td>
						</tr>
						<tr>
							<td><p>Account Number:</p></td>
							<td><p><%= f.text_field :account_number %></p></td>
						</tr>
					</table>
					<br />
				</div>
			<% end %>
			<br />
			<%= f.submit %>
		<% end %>
		<br />
		<%= link_to "I would like to cancel my automated billing entirely.", billing_cancel_path, confirm: "Are you sure?  This will affect your ArtsReady access." %>
  </section>
</div>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script type="text/javascript">
	$.fn.animateHighlight = function(highlightColor, duration) {
	    var highlightBg = highlightColor || "#FFFF9C";
	    var animateMs = duration || 1500;
	    var originalBg = this.css("backgroundColor");
	    this.stop().css("background-color", highlightBg).animate({backgroundColor: originalBg}, animateMs);
	};
	
	function validateCreditCard(s) {
		var v = "0123456789";
		var w = "";
		for (i=0; i < s.length; i++) {
			x = s.charAt(i);
			if (v.indexOf(x,0) != -1)
			w += x;
		}
		j = w.length / 2;
		k = Math.floor(j);
		m = Math.ceil(j) - k;
		c = 0;
		for (i=0; i<k; i++) {
			a = w.charAt(i*2+m) * 2;
			c += a > 9 ? Math.floor(a/10 + a%10) : a;
		}
		for (i=0; i<k+m; i++) c += w.charAt(i*2+1-m) * 1;
		return (c%10 == 0);
	}
		
	$(document).ready(function() {
		$("#discount_submit").click(function() {
			window.location.href = ("/billing/<%= @payment.id %>/edit/"+ $("#discount_code").val())
		})
			
		// $("#payment_billing_first_name").animateHighlight("#dd0000", 2000);
		// 		$("#payment_billing_last_name").animateHighlight("#dd0000", 2000);
		
		$("#payment_type").change(function() {
			var type = "#" + $("#payment_type").val() + "_info";
			$("#cc_info").slideUp();
			$("#bank_info").slideUp();

			$(type).slideDown();
		});
		
		$("#payment_number").blur(function() {
			if (validateCreditCard($(this).val()) == false) {
				$("#bad_card").slideDown();
			} else {
				$("#bad_card").slideUp();
			}
		})
	})
</script>